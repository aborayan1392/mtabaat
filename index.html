<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9" />
    <title>متابعة الطلاب - الإصدار الشامل</title>
    
    <link rel="manifest" href="manifest.json" />

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#107C41',
                        dark: {
                            bg: '#111827',
                            card: '#1f2937',
                            border: '#374151',
                            text: '#f3f4f6',
                            muted: '#9ca3af'
                        }
                    },
                    fontFamily: {
                        // استخدام خطوط النظام الأساسية لضمان سرعة التحميل ودعم العربية
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* تحسينات الواجهة */
        .status-circle { transition: all 0.2s; cursor: pointer; }
        .status-circle:hover { transform: scale(1.15); box-shadow: 0 0 10px rgba(0,0,0,0.15); z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .student-card { transition: transform 0.2s, box-shadow 0.2s; }
        .student-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Color & Icon Pickers */
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: #333; transform: scale(1.1); }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; transition: all 0.2s; }
        .icon-option:hover { background-color: #f3f4f6; }
        .icon-option.selected { background-color: #107C41; color: white; border-color: #107C41; }

        /* Install Bar */
        .install-wrap{display:flex;gap:8px;align-items:center;padding:8px 16px;background:#0b1220;color:#e2e8f0;border-bottom:1px solid rgba(148,163,184,.25)} 
        #installBtn{background:#22c55e;color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer} 
        #installBtn:disabled{opacity:.6;cursor:default}
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen p-3 md:p-6 transition-colors duration-300">

<div class="install-wrap" id="installBar" style="display:none">
  <span>تثبيت التطبيق على جهازك</span>
  <button id="installBtn">تثبيت</button>
</div>

    <div class="max-w-[1400px] mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-t-4 border-primary transition-colors duration-300">
            <div class="flex items-center gap-4">
                <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-xl">
                    <i class="fas fa-users-rectangle text-primary text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white leading-tight">سجل متابعة الطلاب</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-semibold mt-1">نظام البطاقات الذكي</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex flex-wrap justify-center gap-2">
                <button onclick="addNewStudent()" class="bg-primary hover:bg-green-800 text-white px-4 py-2 rounded-xl shadow hover:shadow-md transition-all flex items-center gap-2 font-bold text-sm">
                    <i class="fas fa-plus"></i> إضافة طالب
                </button>
                <button onclick="generateClassReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow hover:shadow-md transition-all flex items-center gap-2 font-bold text-sm">
                    <i class="fas fa-file-pdf"></i> تقرير شامل (PDF)
                </button>
                <button onclick="askToClearData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl shadow hover:shadow-md transition-all flex items-center gap-2 font-bold text-sm">
                    <i class="fas fa-trash"></i> تصفير
                </button>
                <button onclick="openSettingsModal()" class="bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-4 py-2 rounded-xl shadow hover:shadow-md transition-all flex items-center gap-2 font-bold text-sm">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6 transition-all duration-300" id="stats-container"></div>

        <div class="mb-6 flex flex-col md:flex-row gap-3">
            <div class="relative flex-grow">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                </div>
                <input type="text" oninput="handleSearch(this.value)" class="block w-full p-3 pr-10 text-sm text-gray-900 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-primary focus:border-primary shadow-sm transition-all dark:bg-gray-800 dark:border-gray-700 dark:placeholder-gray-400 dark:text-white" placeholder="بحث عن طالب بالاسم...">
            </div>
            <div class="w-full md:w-1/4">
                <div class="relative">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <i class="fas fa-filter text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <select id="grade-filter" onchange="handleGradeFilter(this.value)" class="block w-full p-3 pr-10 text-sm text-gray-900 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-primary focus:border-primary shadow-sm transition-all dark:bg-gray-800 dark:border-gray-700 dark:text-white cursor-pointer appearance-none">
                        <option value="all">عرض كل الصفوف</option>
                    </select>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="students-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 pb-20"></div>
        
        <div id="empty-state" class="hidden text-center py-20 text-gray-400 dark:text-gray-500">
            <div class="bg-gray-50 dark:bg-gray-800 inline-block p-6 rounded-full mb-4 shadow-inner">
                <i class="fas fa-address-card text-5xl text-gray-300 dark:text-gray-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-600 dark:text-gray-300 mb-2">قائمة الطلاب فارغة</h3>
            <p class="text-sm mb-6">لم يتم العثور على طلاب مطابقين للبحث أو الفلتر.</p>
            <button onclick="addNewStudent()" class="text-primary font-bold hover:underline text-sm flex items-center justify-center gap-2 mx-auto">
                <i class="fas fa-plus-circle"></i> إضافة طالب جديد
            </button>
        </div>
    </div>

    <div id="status-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all scale-100 overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                    <span class="bg-green-100 dark:bg-green-900/40 text-primary dark:text-green-400 p-1.5 rounded-lg"><i class="fas fa-fingerprint"></i></span>
                    <span>رصد الحالة</span>
                    <span class="bg-primary text-white text-xs px-2 py-0.5 rounded-full mr-2">الخانة <span id="modal-slot-number"></span></span>
                </h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
             <div class="p-3 text-center bg-yellow-50 dark:bg-gray-700/30 border-b border-yellow-100 dark:border-gray-700">
                <span class="text-sm font-bold text-gray-700 dark:text-gray-300">الطالب: <span id="modal-student-name" class="text-primary dark:text-green-400 text-base"></span></span>
                <div class="text-xs text-gray-500 mt-1" id="modal-date-display"></div>
            </div>
            <div id="modal-current-status-section" class="hidden p-3 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-800 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-blue-800 dark:text-blue-300">الحالة المسجلة:</span>
                    <div id="modal-current-status-display" class="flex items-center gap-2"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="decrementCurrentStatus()" id="btn-decrement" class="hidden text-white bg-amber-500 hover:bg-amber-600 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-minus-circle"></i> إنقاص
                    </button>
                    <button onclick="clearCurrentStatus()" class="text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-trash-alt"></i> مسح
                    </button>
                </div>
            </div>
            <div class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto custom-scrollbar" id="status-options-grid"></div>
            <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex justify-end">
                <button onclick="closeModal()" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 text-gray-700 dark:text-gray-200 px-6 py-2 rounded-lg font-bold text-sm">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[55] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all scale-100 overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 border-b dark:border-gray-700 bg-blue-50 dark:bg-gray-700/50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-history text-blue-600 dark:text-blue-400"></i>
                    <span>سجل الحضور:</span>
                    <span id="history-student-name" class="text-blue-700 dark:text-blue-300 font-extrabold"></span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="generateIndividualReport(currentHistoryStudentId)" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                        <i class="fas fa-file-pdf"></i> <span>تصدير PDF</span>
                    </button>
                    <button onclick="closeHistoryModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <table class="w-full text-sm text-right">
                    <thead class="bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400 uppercase text-xs font-bold tracking-wider">
                        <tr>
                            <th class="px-4 py-3 rounded-r-lg">التاريخ</th>
                            <th class="px-4 py-3">الخانة</th>
                            <th class="px-4 py-3 rounded-l-lg text-center">الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
                <div id="history-empty" class="hidden text-center py-12 text-gray-400">
                    <i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i>
                    <p>لا يوجد سجلات سابقة.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-student-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100 overflow-hidden">
            <div class="p-5 border-b dark:border-gray-700 bg-blue-50 dark:bg-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white">تعديل بيانات الطالب</h3>
                <button onclick="closeEditStudentModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 flex flex-col gap-4">
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">اسم الطالب</label>
                    <input type="text" id="edit-student-name" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">الصف</label>
                    <input type="text" id="edit-student-grade" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <input type="hidden" id="edit-student-id">
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="closeEditStudentModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-bold">إلغاء</button>
                    <button onclick="saveStudentDetails()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 shrink-0">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-cog"></i> <span>الإعدادات</span>
                </h3>
                <button onclick="closeSettingsModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 flex flex-col gap-4 overflow-y-auto custom-scrollbar">
                
                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 class="font-bold text-gray-800 dark:text-white text-sm mb-3">بيانات التقرير</h4>
                    <div class="flex flex-col gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">اسم المدرسة</label>
                            <input type="text" id="setting-school-name" onchange="saveSchoolSettings()" class="w-full p-2 border rounded text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="مثال: مدرسة الرياض الثانوية">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">اسم مدير المدرسة</label>
                            <input type="text" id="setting-principal-name" onchange="saveSchoolSettings()" class="w-full p-2 border rounded text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">اسم معلم التربية البدنية</label>
                            <input type="text" id="setting-teacher-name" onchange="saveSchoolSettings()" class="w-full p-2 border rounded text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                    <h4 class="font-bold text-gray-800 dark:text-white text-sm mb-2">شعار التقرير</h4>
                    <div class="flex flex-col items-center gap-3">
                        <div id="logo-preview-container" class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden bg-white relative">
                            <i class="fas fa-image text-gray-300 text-3xl" id="default-logo-icon"></i>
                            <img id="logo-preview" src="" class="w-full h-full object-contain hidden">
                        </div>
                        <div class="flex gap-2 w-full">
                            <label for="logo-upload" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded-lg text-xs font-bold text-center cursor-pointer transition-colors">
                                <i class="fas fa-upload ml-1"></i> رفع شعار
                            </label>
                            <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="uploadLogo(this)">
                            <button onclick="removeLogo()" class="px-3 py-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors" title="حذف الشعار">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-amber-100 text-amber-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-list-check"></i></div>
                        <h4 class="font-bold text-sm dark:text-white">إدارة الحالات</h4>
                    </div>
                    <button onclick="openStatusManager()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-1.5 rounded-lg text-xs font-bold">تعديل</button>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-100 dark:border-gray-600 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-moon"></i></div>
                        <h4 class="font-bold text-sm dark:text-white">الوضع الداكن</h4>
                    </div>
                    <button onclick="toggleTheme()" id="theme-toggle-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none bg-gray-200 dark:bg-purple-600">
                        <span id="theme-toggle-circle" class="translate-x-1 inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 dark:translate-x-6"></span>
                    </button>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-100 dark:border-gray-600 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-chart-bar"></i></div>
                        <h4 class="font-bold text-sm dark:text-white">عرض الإحصائيات</h4>
                    </div>
                    <button onclick="toggleStats()" id="stats-toggle-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none bg-indigo-600">
                        <span id="stats-toggle-circle" class="translate-x-6 inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200"></span>
                    </button>
                </div>

                 <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-800 text-center">
                    <button onclick="document.getElementById('import-txt-file').click()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg shadow mb-2 text-sm font-bold">
                        <i class="fas fa-list-ol ml-2"></i> استيراد أسماء (TXT)
                    </button>
                    <input type="file" id="import-txt-file" accept=".txt" class="hidden" onchange="importNamesFromText(this)">
                    
                    <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg shadow mb-2 text-sm font-bold">
                        <i class="fas fa-download ml-2"></i> تصدير نسخة احتياطية (JSON)
                    </button>
                    
                    <button onclick="document.getElementById('import-file').click()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg shadow text-sm font-bold">
                        <i class="fas fa-upload ml-2"></i> استعادة نسخة (JSON)
                    </button>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                </div>
            </div>
        </div>
    </div>

    <div id="status-manager-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-100 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 shrink-0">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-list-check text-amber-600"></i> <span>إدارة الحالات</span>
                </h3>
                <button onclick="closeStatusManager()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-400 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 class="font-bold text-sm mb-3 text-gray-700 dark:text-gray-300">إضافة حالة جديدة</h4>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="new-status-name" class="w-full p-2 text-sm border rounded dark:bg-gray-800 dark:text-white" placeholder="اسم الحالة (مثال: ممتاز)">
                        <div>
                            <p class="text-xs text-gray-500 mb-2">اختر لون:</p>
                            <div class="flex gap-2 flex-wrap" id="color-picker-container"></div>
                            <input type="hidden" id="selected-color-key">
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-2">اختر أيقونة:</p>
                            <div class="grid grid-cols-6 gap-2" id="icon-picker-container"></div>
                            <input type="hidden" id="selected-icon-class">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="new-status-stats" class="w-4 h-4 text-primary rounded" checked>
                            <label for="new-status-stats" class="text-xs text-gray-600 dark:text-gray-400">إضافة للإحصائيات</label>
                        </div>
                        <button onclick="addNewStatusType()" class="bg-primary hover:bg-green-700 text-white w-full py-2 rounded font-bold text-sm mt-2">إضافة</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-sm mb-3 text-gray-700 dark:text-gray-300 border-b pb-2">الحالات الحالية</h4>
                    <div id="status-list-container" class="flex flex-col gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="grade-selection-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100 overflow-hidden">
            <div class="p-5 border-b dark:border-gray-700 bg-orange-50 dark:bg-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white">تحديد الصف</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">تم العثور على <span id="imported-count" class="font-bold text-orange-600">0</span> اسم.</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">اكتب اسم الصف لإضافته لهؤلاء الطلاب:</p>
                </div>
                <input type="text" id="import-grade-input" class="block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="مثال: ثاني ثانوي (أ)">
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="closeGradeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold text-sm">إلغاء</button>
                    <button onclick="confirmImportNames()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-bold text-sm">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-dialog-modal" class="fixed inset-0 bg-gray-900/70 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity no-print">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100 overflow-hidden border-t-4 border-transparent" id="custom-dialog-header">
            <div class="p-6 text-center">
                <i id="custom-dialog-icon" class="fas text-4xl mb-4 block transition-colors"></i>
                <h3 id="custom-dialog-title" class="font-bold text-xl text-gray-800 dark:text-white mb-2"></h3>
                <p id="custom-dialog-message" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-6"></p>
                <div id="custom-dialog-actions" class="flex justify-center gap-3"></div>
            </div>
        </div>
    </div>

    <script>
        // --- البيانات والإعدادات ---
        const DEFAULT_STATUS_TYPES = {
            'none': { label: 'لم يرصد', icon: 'fa-circle', color: 'text-gray-300 dark:text-gray-600', bg: 'bg-gray-100 dark:bg-gray-700', stats: false },
            'present_kit': { label: 'حاضر (زي رياضي)', icon: 'fa-tshirt', color: 'text-green-600 dark:text-green-400', bg: 'bg-green-100 dark:bg-green-900/40', stats: true },
            'present_no_kit': { label: 'حاضر (بدون زي)', icon: 'fa-user-tie', color: 'text-orange-600 dark:text-orange-400', bg: 'bg-orange-100 dark:bg-orange-900/40', stats: true },
            'participating': { label: 'مشارك', icon: 'fa-star', color: 'text-yellow-500 dark:text-yellow-400', bg: 'bg-yellow-50 dark:bg-yellow-900/30', stats: true },
            'absent': { label: 'غائب', icon: 'fa-user-xmark', color: 'text-red-600 dark:text-red-400', bg: 'bg-red-100 dark:bg-red-900/40', stats: true },
            'late': { label: 'متأخر', icon: 'fa-clock', color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-100 dark:bg-amber-900/40', stats: true },
            'excused': { label: 'مستأذن', icon: 'fa-file-signature', color: 'text-blue-600 dark:text-blue-400', bg: 'bg-blue-100 dark:bg-blue-900/40', stats: true },
            'sick': { label: 'مريض', icon: 'fa-truck-medical', color: 'text-pink-600 dark:text-pink-400', bg: 'bg-pink-100 dark:bg-pink-900/40', stats: true },
            'escape': { label: 'هروب', icon: 'fa-person-running', color: 'text-red-800 dark:text-red-500', bg: 'bg-red-200 dark:bg-red-900/60', stats: true },
            'disruptive': { label: 'مشاغب', icon: 'fa-bolt', color: 'text-purple-600 dark:text-purple-400', bg: 'bg-purple-100 dark:bg-purple-900/40', stats: true },
            'apathetic': { label: 'لا مبالاة', icon: 'fa-face-rolling-eyes', color: 'text-gray-500 dark:text-gray-400', bg: 'bg-gray-200 dark:bg-gray-600', stats: true },
            'not_participating': { label: 'غير مشارك', icon: 'fa-ban', color: 'text-gray-700 dark:text-gray-300', bg: 'bg-gray-300 dark:bg-gray-600', stats: true },
        };

        const STATUS_COLORS = {
            'green': { color: 'text-green-600 dark:text-green-400', bg: 'bg-green-100 dark:bg-green-900/40', display: '#16a34a' },
            'red': { color: 'text-red-600 dark:text-red-400', bg: 'bg-red-100 dark:bg-red-900/40', display: '#dc2626' },
            'blue': { color: 'text-blue-600 dark:text-blue-400', bg: 'bg-blue-100 dark:bg-blue-900/40', display: '#2563eb' },
            'yellow': { color: 'text-yellow-500 dark:text-yellow-400', bg: 'bg-yellow-50 dark:bg-yellow-900/30', display: '#eab308' },
            'orange': { color: 'text-orange-600 dark:text-orange-400', bg: 'bg-orange-100 dark:bg-orange-900/40', display: '#ea580c' },
            'purple': { color: 'text-purple-600 dark:text-purple-400', bg: 'bg-purple-100 dark:bg-purple-900/40', display: '#9333ea' },
            'pink': { color: 'text-pink-600 dark:text-pink-400', bg: 'bg-pink-100 dark:bg-pink-900/40', display: '#db2777' },
            'gray': { color: 'text-gray-600 dark:text-gray-400', bg: 'bg-gray-200 dark:bg-gray-700', display: '#4b5563' },
            'indigo': { color: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-100 dark:bg-indigo-900/40', display: '#4f46e5' },
            'teal': { color: 'text-teal-600 dark:text-teal-400', bg: 'bg-teal-100 dark:bg-teal-900/40', display: '#0d9488' }
        };

        const STATUS_ICONS = ['fa-circle', 'fa-check', 'fa-times', 'fa-star', 'fa-user', 'fa-user-clock', 'fa-heart', 'fa-thumbs-up', 'fa-thumbs-down', 'fa-exclamation', 'fa-question', 'fa-trophy', 'fa-medal', 'fa-bolt', 'fa-ban', 'fa-running', 'fa-football-ball', 'fa-basketball-ball'];

        let statusTypes = JSON.parse(localStorage.getItem('pe_status_types')) || DEFAULT_STATUS_TYPES;
        let rawData = JSON.parse(localStorage.getItem('pe_students')) || [];
        
        // إصلاح بيانات الطلاب القديمة إن وجدت
        let students = rawData.map(s => {
            if (s.attendance_log) {
                for (const key in s.attendance_log) {
                    if (typeof s.attendance_log[key] === 'string') {
                        s.attendance_log[key] = { status: s.attendance_log[key], count: 1 };
                    }
                }
            } else if (Array.isArray(s.statuses)) {
                return { id: s.id, name: s.name, grade: s.grade, attendance_log: s.attendance_log || {}, notes: s.notes || '' };
            }
            return s.attendance_log ? s : { id: s.id || Date.now(), name: s.name || '', grade: s.grade || '', attendance_log: {}, notes: s.notes || '' };
        });
        
        if (students.length === 0) students = [];

        let currentEditingId = null;
        let currentEditingSlot = null; 
        let currentSearchTerm = '';
        let currentFilterGrade = 'all'; 
        let currentHistoryStudentId = null;
        let isDarkMode = localStorage.getItem('pe_dark_mode') === 'true';
        let showStats = localStorage.getItem('pe_show_stats') !== 'false';
        let pendingImportNames = [];
        
        // المتغيرات الجديدة (الشعار والأسماء)
        let customLogo = localStorage.getItem('pe_custom_logo') || null;
        let schoolName = localStorage.getItem('pe_school_name') || '';
        let principalName = localStorage.getItem('pe_principal_name') || '';
        let teacherName = localStorage.getItem('pe_teacher_name') || '';

        function init() {
            applyTheme();
            applyStatsVisibility();
            populateGradeFilter(); 
            renderTable();
            renderStats();
            renderModalOptions();
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // --- المظهر ---
        function applyTheme() {
            if (isDarkMode) { document.documentElement.classList.add('dark'); } 
            else { document.documentElement.classList.remove('dark'); }
            updateToggleUI('theme-toggle-btn', 'theme-toggle-circle', isDarkMode, 'bg-purple-600');
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('pe_dark_mode', isDarkMode);
            applyTheme();
        }

        function applyStatsVisibility() {
            const container = document.getElementById('stats-container');
            if (showStats) { container.classList.remove('hidden'); renderStats(); } 
            else { container.classList.add('hidden'); }
            updateToggleUI('stats-toggle-btn', 'stats-toggle-circle', showStats, 'bg-indigo-600');
        }

        function toggleStats() {
            showStats = !showStats;
            localStorage.setItem('pe_show_stats', showStats);
            applyStatsVisibility();
        }

        function updateToggleUI(btnId, circleId, isActive, activeColorClass) {
            const btn = document.getElementById(btnId);
            const circle = document.getElementById(circleId);
            if (btn && circle) {
                if (isActive) {
                    btn.classList.add(activeColorClass); btn.classList.remove('bg-gray-200');
                    circle.classList.add('translate-x-6'); circle.classList.remove('translate-x-1');
                } else {
                    btn.classList.remove(activeColorClass); btn.classList.add('bg-gray-200');
                    circle.classList.remove('translate-x-6'); circle.classList.add('translate-x-1');
                }
            }
        }

        // --- الفلترة والبحث ---
        function handleSearch(val) { currentSearchTerm = val; renderTable(); }
        function handleGradeFilter(val) { currentFilterGrade = val; renderTable(); }

        function populateGradeFilter() {
            const filterEl = document.getElementById('grade-filter');
            const grades = [...new Set(students.map(s => s.grade).filter(g => g))].sort();
            filterEl.innerHTML = '<option value="all">عرض كل الصفوف</option>';
            grades.forEach(g => {
                const option = document.createElement('option');
                option.value = g; option.innerText = g;
                filterEl.appendChild(option);
            });
            filterEl.value = grades.includes(currentFilterGrade) ? currentFilterGrade : 'all';
            if (!grades.includes(currentFilterGrade)) currentFilterGrade = 'all';
        }

        // --- منطق التصدير PDF (النسخة المستقرة) ---
        async function downloadPDF(htmlContent, filename) {
            const styles = `
                <style>
                    body { 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; 
                        direction: rtl; 
                        margin: 0; padding: 0; 
                        background: #fff;
                    }
                    .pdf-container {
                        width: 210mm;
                        min-height: 297mm;
                        margin: 0 auto;
                        padding: 10mm 15mm; 
                        background: white;
                        color: black !important;
                        font-size: 11px;
                        box-sizing: border-box;
                    }
                    .rpt-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; width: 100%; }
                    .rpt-header-col { width: 30%; text-align: center; }
                    .rpt-header-right { text-align: right; }
                    .rpt-header-left { text-align: left; }
                    .rpt-title-main { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
                    .rpt-title-sub { font-size: 10px; font-weight: normal; color: #000; margin-bottom: 2px; }
                    .rpt-doc-title { text-align: center; font-size: 18px; font-weight: 800; margin: 15px 0; text-decoration: underline; }
                    .rpt-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10px; table-layout: fixed; }
                    .rpt-table th, .rpt-table td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; word-wrap: break-word; }
                    .rpt-table th { background-color: #eee !important; font-weight: bold; }
                    .rpt-table tr:nth-child(even) td { background-color: #f9f9f9 !important; }
                    .rpt-footer { margin-top: 30px; display: flex; justify-content: space-between; }
                    .rpt-sig-box { width: 30%; text-align: center; }
                    .rpt-sig-title { font-weight: bold; margin-bottom: 30px; font-size: 11px; }
                    .rpt-sig-name { font-size: 12px; margin-bottom: 5px; font-weight:bold; } 
                    .rpt-sig-line { border-top: 1px solid #000; width: 80%; margin: 0 auto; }
                    .rpt-info-box { border: 1px solid #000; border-radius: 4px; padding: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; background-color: #f9f9f9; }
                    .rpt-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
                    .rpt-stat-card { border: 1px solid #000; padding: 5px; text-align: center; border-radius: 4px; }
                    .rpt-stat-num { font-size: 16px; font-weight: bold; display: block; }
                    .rpt-stat-txt { font-size: 10px; }
                </style>
            `;

            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '-9999px'; 
            overlay.style.zIndex = '9999';
            overlay.style.backgroundColor = '#fff';
            overlay.innerHTML = `<div class="pdf-container" id="report-content" dir="rtl" lang="ar">${styles}${htmlContent}</div>`;
            document.body.appendChild(overlay);

            showDialog({ title: 'جاري التصدير', message: 'جاري تجهيز الملف... (يرجى الانتظار)', type: 'info' });

            try {
                const element = document.getElementById('report-content');
                await new Promise(r => setTimeout(r, 200)); // انتظار بسيط للتأكد من الرسم

                // استخدام fontEmbedCSS فارغ لتجنب تعليق تحميل الخطوط
                const dataUrl = await htmlToImage.toPng(element, { quality: 0.95, pixelRatio: 2, fontEmbedCSS: '' });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const imgProps = pdf.getImageProperties(dataUrl);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                const pageHeight = pdf.internal.pageSize.getHeight();

                if (pdfHeight > pageHeight) {
                     let heightLeft = pdfHeight;
                     let position = 0;
                     pdf.addImage(dataUrl, 'PNG', 0, position, pdfWidth, pdfHeight);
                     heightLeft -= pageHeight;
                     while (heightLeft > 0) {
                        pdf.addPage();
                        pdf.addImage(dataUrl, 'PNG', 0, - (pdfHeight - heightLeft), pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;
                     }
                } else {
                    pdf.addImage(dataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight);
                }

                pdf.save(filename + '.pdf');
                document.body.removeChild(overlay);
                closeDialog();

            } catch (error) {
                console.error(error);
                if(overlay) document.body.removeChild(overlay);
                closeDialog();
                alert("حدث خطأ أثناء التصدير. يرجى المحاولة مرة أخرى.");
            }
        }

        // --- دوال بناء التقارير ---
        function getReportHeader(title) {
            const today = new Date().toLocaleDateString('ar-SA');
            let centerContent = '';
            
            if (customLogo) {
                centerContent = `<img src="${customLogo}" style="max-height: 80px; max-width: 100px;">`;
            } else {
                centerContent = `<i class="fas fa-running" style="font-size: 35px; color: #107C41;"></i>`;
            }

            return `
                <div class="rpt-header">
                    <div class="rpt-header-col rpt-header-right">
                        <div class="rpt-title-main">المملكة العربية السعودية</div>
                        <div class="rpt-title-sub">وزارة التعليم</div>
                        <div class="rpt-title-sub">الإدارة العامة للتعليم</div>
                        <div class="rpt-title-sub">${schoolName || 'مدرسة .........................'}</div>
                    </div>
                    <div class="rpt-header-col rpt-header-center">
                        ${centerContent}
                    </div>
                    <div class="rpt-header-col rpt-header-left">
                        <div class="rpt-title-sub"><b>التاريخ:</b> ${today}</div>
                        <div class="rpt-title-sub"><b>الموافق:</b> ...................</div>
                    </div>
                </div>
                <div class="rpt-doc-title">${title}</div>
            `;
        }

        function generateClassReport() {
            if (students.length === 0) {
                showDialog({ title: 'تنبيه', message: 'لا يوجد طلاب لتصدير التقرير.', type: 'danger' });
                return;
            }
            const gradeText = currentFilterGrade !== 'all' ? ` (${currentFilterGrade})` : '';
            let html = `<div class="keep-together-block">${getReportHeader('كشف متابعة الطلاب' + gradeText)}</div>
                <table class="rpt-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="35%">اسم الطالب</th>
                            <th width="15%">الصف</th>
                            <th width="10%">حضور</th>
                            <th width="10%">غياب</th>
                            <th width="10%">لا زي</th>
                            <th width="15%">آخر حالة</th>
                        </tr>
                    </thead>
                    <tbody>`;

            const reportStudents = students.filter(s => currentFilterGrade === 'all' || s.grade === currentFilterGrade);
            if(reportStudents.length === 0) { html += `<tr><td colspan="7" style="padding: 10px;">لا توجد بيانات لهذا الصف</td></tr>`; }

            reportStudents.forEach((student, index) => {
                let presentCount = 0, absentCount = 0, noKitCount = 0;
                let lastStatusLabel = '-';
                const logs = Object.entries(student.attendance_log);
                logs.forEach(([key, val]) => {
                    const status = val.status || val;
                    const count = val.count || 1;
                    if (status === 'present_kit' || status === 'participating') presentCount += count;
                    if (status === 'absent') absentCount += count;
                    if (status === 'present_no_kit') noKitCount += count;
                });
                if (logs.length > 0) {
                    logs.sort((a, b) => b[0].localeCompare(a[0]));
                    const lastEntry = logs[0][1];
                    const st = statusTypes[lastEntry.status || lastEntry];
                    lastStatusLabel = st ? st.label : (lastEntry.status || lastEntry);
                }
                html += `<tr><td>${index + 1}</td><td style="text-align: right; padding-right: 5px;"><strong>${student.name}</strong></td><td>${student.grade}</td><td>${presentCount}</td><td>${absentCount}</td><td>${noKitCount}</td><td>${lastStatusLabel}</td></tr>`;
            });
            html += `</tbody></table>`;
            html += getReportFooter();
            downloadPDF(html, 'تقرير_شامل');
        }

        function generateIndividualReport(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            let html = `<div class="keep-together-block">${getReportHeader('بيان حالة طالب - تفصيلي')}`;
            html += `<div class="rpt-info-box"><div style="display: flex; flex-direction: column;"><span style="font-size: 10px; color: #555; font-weight: bold;">اسم الطالب</span><span style="font-size: 12px; font-weight: bold;">${student.name}</span></div><div style="display: flex; flex-direction: column;"><span style="font-size: 10px; color: #555; font-weight: bold;">الصف الدراسي</span><span style="font-size: 12px; font-weight: bold;">${student.grade}</span></div><div style="display: flex; flex-direction: column; flex: 1; margin-right: 15px;"><span style="font-size: 10px; color: #555; font-weight: bold;">الملاحظات</span><span style="font-size: 12px; font-weight: bold;">${student.notes || 'لا توجد'}</span></div></div>`;
            const logs = Object.entries(student.attendance_log).sort((a, b) => b[0].localeCompare(a[0]));
            let present = 0, absent = 0, excused = 0;
            logs.forEach(([, val]) => {
                const status = val.status || val;
                const count = val.count || 1;
                if(['present_kit', 'participating', 'present_no_kit'].includes(status)) present += count;
                if(status === 'absent') absent += count;
                if(status === 'excused') excused += count;
            });
            html += `<div class="rpt-stats-grid"><div class="rpt-stat-card" style="background: #f0fdf4 !important; border-color: #166534;"><span class="rpt-stat-num" style="color: #166534;">${present}</span><span class="rpt-stat-txt">أيام الحضور</span></div><div class="rpt-stat-card" style="background: #fef2f2 !important; border-color: #991b1b;"><span class="rpt-stat-num" style="color: #991b1b;">${absent}</span><span class="rpt-stat-txt">أيام الغياب</span></div><div class="rpt-stat-card" style="background: #eff6ff !important; border-color: #1e40af;"><span class="rpt-stat-num" style="color: #1e40af;">${excused}</span><span class="rpt-stat-txt">أعذار مقبولة</span></div></div></div>`;
            if (logs.length === 0) { html += `<div style="text-align: center; padding: 20px; border: 1px dashed #999;">لا يوجد سجل حضور مسجل.</div>`; } else {
                html += `<div style="font-weight: bold; margin-bottom: 5px; border-bottom: 2px solid #333;">سجل المتابعة اليومي:</div><table class="rpt-table"><thead><tr><th width="25%">التاريخ</th><th width="15%">الخانة</th><th width="60%">الحالة</th></tr></thead><tbody>`;
                logs.forEach(([key, val]) => {
                    const status = val.status || val;
                    const count = val.count || 1;
                    const config = statusTypes[status] || statusTypes['none'];
                    if(!config) return;
                    let datePart = key.includes('_slot_') ? key.split('_slot_')[0] : key;
                    let slotPart = key.includes('_slot_') ? 'الخانة ' + key.split('_slot_')[1] : '-';
                    html += `<tr><td style="font-family: monospace;">${datePart}</td><td>${slotPart}</td><td>${config.label} ${count > 1 ? `(x${count})` : ''}</td></tr>`;
                });
                html += `</tbody></table>`;
            }
            html += getReportFooter();
            downloadPDF(html, `تقرير_${student.name.replace(/\s/g, '_')}`);
        }

        function getReportFooter() {
            return `
                <div class="rpt-footer">
                    <div class="rpt-sig-box">
                        <p class="rpt-sig-title">معلم التربية البدنية</p>
                        ${teacherName ? `<p class="rpt-sig-name">${teacherName}</p>` : ''}
                        <div class="rpt-sig-line"></div>
                    </div>
                    <div class="rpt-sig-box">
                        <p class="rpt-sig-title">وكيل الشؤون الطلابية</p>
                        <div class="rpt-sig-line" style="margin-top: 17px;"></div>
                    </div>
                    <div class="rpt-sig-box">
                        <p class="rpt-sig-title">مدير المدرسة</p>
                        ${principalName ? `<p class="rpt-sig-name">${principalName}</p>` : ''}
                        <div class="rpt-sig-line"></div>
                    </div>
                </div>
            `;
        }

        // --- دوال الإعدادات (الشعار، الأسماء، الحفظ) ---
        function renderLogoSettings() {
            const img = document.getElementById('logo-preview');
            const icon = document.getElementById('default-logo-icon');
            if (customLogo) {
                img.src = customLogo;
                img.classList.remove('hidden');
                icon.classList.add('hidden');
            } else {
                img.src = '';
                img.classList.add('hidden');
                icon.classList.remove('hidden');
            }
        }

        function uploadLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (e.target.result.length > 2000000) { 
                         showDialog({ title: 'خطأ', message: 'حجم الصورة كبير جداً. يرجى اختيار صورة أصغر.', type: 'danger' });
                         return;
                    }
                    customLogo = e.target.result;
                    localStorage.setItem('pe_custom_logo', customLogo);
                    renderLogoSettings();
                    showDialog({ title: 'نجاح', message: 'تم حفظ الشعار بنجاح.', type: 'success' });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeLogo() {
            if(confirm('هل تريد حذف الشعار المخصص والعودة للافتراضي؟')) {
                customLogo = null;
                localStorage.removeItem('pe_custom_logo');
                renderLogoSettings();
            }
        }

        function saveSchoolSettings() {
            schoolName = document.getElementById('setting-school-name').value;
            principalName = document.getElementById('setting-principal-name').value;
            teacherName = document.getElementById('setting-teacher-name').value;

            localStorage.setItem('pe_school_name', schoolName);
            localStorage.setItem('pe_principal_name', principalName);
            localStorage.setItem('pe_teacher_name', teacherName);
        }

        // --- وظائف التطبيق الأساسية (CRUD) ---
        
        function openStatusManager() {
            closeSettingsModal();
            renderStatusList(); renderColorPicker(); renderIconPicker();
            const modal = document.getElementById('status-manager-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.add('scale-100'); }, 10);
        }
        function closeStatusManager() {
            const modal = document.getElementById('status-manager-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); openSettingsModal(); }, 200);
        }
        function renderStatusList() {
            const container = document.getElementById('status-list-container'); container.innerHTML = '';
            Object.entries(statusTypes).forEach(([key, config]) => {
                if(key === 'none') return;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 shadow-sm';
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center ${config.bg} ${config.color} border border-gray-200"><i class="fas ${config.icon}"></i></div><span class="text-sm font-bold dark:text-white">${config.label}</span>${config.stats ? '<span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded">إحصاء</span>' : ''}</div><button onclick="deleteStatusType('${key}')" class="text-red-500 hover:bg-red-100 p-1 rounded transition-colors"><i class="fas fa-trash"></i></button>`;
                container.appendChild(div);
            });
        }
        function renderColorPicker() {
            const container = document.getElementById('color-picker-container'); container.innerHTML = '';
            Object.entries(STATUS_COLORS).forEach(([key, val]) => {
                const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = val.display;
                swatch.onclick = () => { document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected')); swatch.classList.add('selected'); document.getElementById('selected-color-key').value = key; };
                container.appendChild(swatch);
            });
            if(container.firstChild) container.firstChild.click();
        }
        function renderIconPicker() {
            const container = document.getElementById('icon-picker-container'); container.innerHTML = '';
            STATUS_ICONS.forEach(iconClass => {
                const iconBox = document.createElement('div'); iconBox.className = 'icon-option'; iconBox.innerHTML = `<i class="fas ${iconClass}"></i>`;
                iconBox.onclick = () => { document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected')); iconBox.classList.add('selected'); document.getElementById('selected-icon-class').value = iconClass; };
                container.appendChild(iconBox);
            });
            if(container.firstChild) container.firstChild.click();
        }
        function addNewStatusType() {
            const name = document.getElementById('new-status-name').value.trim();
            const colorKey = document.getElementById('selected-color-key').value;
            const iconClass = document.getElementById('selected-icon-class').value;
            const stats = document.getElementById('new-status-stats').checked;
            if (!name) return alert('الرجاء كتابة اسم الحالة');
            const newKey = 'status_' + Date.now();
            const colorConfig = STATUS_COLORS[colorKey] || STATUS_COLORS['gray'];
            statusTypes[newKey] = { label: name, icon: iconClass || 'fa-circle', color: colorConfig.color, bg: colorConfig.bg, stats: stats };
            saveStatusTypes(); renderStatusList(); document.getElementById('new-status-name').value = ''; renderModalOptions(); renderTable(); renderStats();
        }
        function deleteStatusType(key) {
            if(confirm('هل أنت متأكد من حذف هذه الحالة؟')) { delete statusTypes[key]; saveStatusTypes(); renderStatusList(); renderModalOptions(); renderTable(); renderStats(); }
        }
        function saveStatusTypes() { localStorage.setItem('pe_status_types', JSON.stringify(statusTypes)); }

        function renderTable() {
            const container = document.getElementById('students-container');
            const emptyState = document.getElementById('empty-state');
            container.innerHTML = '';
            const filtered = students.filter(s => s.name.includes(currentSearchTerm) && (currentFilterGrade === 'all' || s.grade === currentFilterGrade));
            if (filtered.length === 0) { emptyState.classList.remove('hidden'); container.classList.add('hidden'); document.querySelector('#empty-state h3').innerText = students.length === 0 ? "قائمة الطلاب فارغة" : "لا يوجد طلاب مطابقين"; return; }
            emptyState.classList.add('hidden'); container.classList.remove('hidden');
            const today = getTodayKey();
            filtered.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 overflow-hidden flex flex-col relative group';
                let circlesHtml = '<div class="p-4 grid grid-cols-5 gap-2">';
                for(let i=1; i<=10; i++) {
                    const slotKey = `${today}_slot_${i}`;
                    const entry = student.attendance_log[slotKey];
                    const statusKey = entry ? entry.status : 'none';
                    const count = entry ? (entry.count || 1) : 1;
                    const config = statusTypes[statusKey] || statusTypes['none'] || DEFAULT_STATUS_TYPES['none'];
                    circlesHtml += `<div class="flex flex-col items-center gap-1 w-full relative"><div onclick="openStatusModal(${student.id}, ${i})" class="status-circle w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm shadow-sm border-2 border-white dark:border-gray-600 ${config.color} ${config.bg} relative group/tooltip"><i class="fas ${config.icon}"></i>${count > 1 ? `<span class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-sm z-20">${count}</span>` : ''}</div><span class="text-[10px] text-gray-400 font-mono">${i}</span></div>`;
                }
                circlesHtml += '</div>';
                card.innerHTML = `<div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center text-xl font-bold shadow-sm">${student.name.charAt(0)}</div><div class="overflow-hidden"><h3 class="font-bold text-gray-800 dark:text-white text-sm truncate">${student.name}</h3><p class="text-xs text-gray-500 dark:text-gray-400 truncate">${student.grade}</p></div></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openEditStudentModal(${student.id})" class="text-gray-500 hover:bg-gray-200 p-2 rounded-lg"><i class="fas fa-pen"></i></button><button onclick="openHistoryModal(${student.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg"><i class="fas fa-history"></i></button><button onclick="askToDeleteStudent(${student.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg"><i class="fas fa-trash-alt"></i></button></div></div>${circlesHtml}<div class="px-4 pb-4 pt-0"><div class="relative"><i class="fas fa-pen absolute right-3 top-3 text-gray-300 text-xs"></i><input type="text" value="${student.notes}" onchange="updateStudent(${student.id}, 'notes', this.value)" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 rounded-lg py-2 pr-8 pl-3 text-xs text-gray-600 dark:text-gray-300 focus:ring-1 focus:ring-primary outline-none" placeholder="ملاحظات..."></div></div>`;
                container.appendChild(card);
            });
            saveData();
        }

        function renderStats() {
            const container = document.getElementById('stats-container');
            if (!showStats) return;
            container.innerHTML = '';
            const counts = {}, today = getTodayKey();
            let totalEntries = 0;
            Object.keys(statusTypes).forEach(key => { if (statusTypes[key].stats) counts[key] = 0; });
            students.forEach(s => {
                if (currentFilterGrade !== 'all' && s.grade !== currentFilterGrade) return;
                for(let i=1; i<=10; i++) {
                    const entry = s.attendance_log[`${today}_slot_${i}`];
                    if (entry && statusTypes[entry.status]?.stats) { counts[entry.status] += (entry.count || 1); totalEntries += (entry.count || 1); }
                }
            });
            container.innerHTML += `<div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border-r-4 border-gray-600 dark:border-gray-500 flex justify-between items-center"><div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"><i class="fas fa-calendar-day text-gray-400 text-lg"></i></div><div><span class="block text-gray-400 text-[10px] font-bold">رصد اليوم</span><span class="block text-2xl font-bold text-gray-700 dark:text-gray-200 font-mono leading-none mt-1">${totalEntries}</span></div></div>`;
            Object.keys(counts).forEach(key => {
                if (counts[key] > 0) {
                    const config = statusTypes[key];
                    if(!config) return;
                    container.innerHTML += `<div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border-r-4 ${config.color.split(' ')[0].replace('text-', 'border-')} flex justify-between items-center"><div class="${config.bg} p-2 rounded-lg shrink-0"><i class="fas ${config.icon} ${config.color} text-lg"></i></div><div class="overflow-hidden text-left"><span class="block text-gray-500 dark:text-gray-400 text-[10px] font-bold truncate">${config.label}</span><span class="block text-xl font-bold ${config.color} font-mono leading-none mt-1">${counts[key]}</span></div></div>`;
                }
            });
        }

        function renderModalOptions() {
            const grid = document.getElementById('status-options-grid'); grid.innerHTML = '';
            Object.entries(statusTypes).forEach(([key, config]) => {
                if (key === 'none') return;
                const btn = document.createElement('button');
                btn.className = `flex flex-col items-center justify-center p-3 rounded-xl border transition-all hover:scale-105 ${config.bg} hover:shadow-lg border-transparent`;
                btn.onclick = () => setStatus(key);
                btn.innerHTML = `<div class="w-10 h-10 rounded-full bg-white bg-opacity-60 flex items-center justify-center mb-1 shadow-sm"><i class="fas ${config.icon} text-xl ${config.color}"></i></div><span class="font-bold text-xs text-gray-700 dark:text-gray-300">${config.label}</span>`;
                grid.appendChild(btn);
            });
        }

        function openHistoryModal(id) {
            currentHistoryStudentId = id; const student = students.find(s => s.id === id); if(!student) return;
            document.getElementById('history-student-name').innerText = student.name;
            const tbody = document.getElementById('history-table-body'); tbody.innerHTML = '';
            const keys = Object.keys(student.attendance_log).sort((a, b) => b.localeCompare(a));
            if (keys.length === 0) { document.getElementById('history-empty').classList.remove('hidden'); document.querySelector('#history-modal table').classList.add('hidden'); } 
            else {
                document.getElementById('history-empty').classList.add('hidden'); document.querySelector('#history-modal table').classList.remove('hidden');
                keys.forEach(key => {
                    const entry = student.attendance_log[key], status = entry.status || entry, count = entry.count || 1;
                    const config = statusTypes[status]; if (!config) return;
                    let datePart = key.includes('_slot_') ? key.split('_slot_')[0] : key;
                    let slotPart = key.includes('_slot_') ? 'الخانة ' + key.split('_slot_')[1] : 'عام';
                    tbody.innerHTML += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50"><td class="px-4 py-3 border-b dark:border-gray-700 font-mono text-gray-600 dark:text-gray-400">${datePart}</td><td class="px-4 py-3 border-b dark:border-gray-700 text-gray-800 dark:text-gray-300 font-bold">${slotPart}</td><td class="px-4 py-3 border-b dark:border-gray-700 text-center"><span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold ${config.bg} ${config.color.split(' ')[0]}"><i class="fas ${config.icon}"></i>${config.label}${count > 1 ? ` x${count}` : ''}</span></td></tr>`;
                });
            }
            const modal = document.getElementById('history-modal'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.add('scale-100'); }, 10);
        }
        function closeHistoryModal() { const modal = document.getElementById('history-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }

        function showDialog(opt) {
            const modal = document.getElementById('custom-dialog-modal'), title = document.getElementById('custom-dialog-title'), msg = document.getElementById('custom-dialog-message'), icon = document.getElementById('custom-dialog-icon'), actions = document.getElementById('custom-dialog-actions'), header = document.getElementById('custom-dialog-header');
            icon.className = 'fas text-4xl mb-4 block transition-colors'; header.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100 overflow-hidden border-t-4';
            title.innerText = opt.title || 'تنبيه'; msg.innerText = opt.message || '';
            if (opt.type === 'danger') { icon.classList.add('text-red-500', 'fa-exclamation-triangle'); header.classList.add('border-red-500'); } 
            else if (opt.type === 'success') { icon.classList.add('text-green-500', 'fa-check-circle'); header.classList.add('border-green-500'); } 
            else { icon.classList.add('text-blue-500', 'fa-info-circle'); header.classList.add('border-blue-500'); }
            actions.innerHTML = '';
            if (opt.isConfirm) {
                const cancel = document.createElement('button'); cancel.className = 'bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 px-5 py-2 rounded-lg font-bold text-sm'; cancel.innerText = 'إلغاء'; cancel.onclick = closeDialog;
                const confirm = document.createElement('button'); confirm.className = `px-5 py-2 rounded-lg font-bold text-white text-sm ${opt.type === 'danger' ? 'bg-red-600' : 'bg-primary'}`; confirm.innerText = 'نعم، تابع'; confirm.onclick = () => { if(opt.onConfirm) opt.onConfirm(); closeDialog(); };
                actions.append(cancel, confirm);
            } else {
                const ok = document.createElement('button'); ok.className = 'bg-gray-800 dark:bg-gray-600 text-white px-8 py-2 rounded-lg font-bold text-sm'; ok.innerText = 'موافق'; ok.onclick = closeDialog; actions.appendChild(ok);
            }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.add('scale-100'); }, 10);
        }
        function closeDialog() { const modal = document.getElementById('custom-dialog-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }

        function addNewStudent() {
            const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
            students.push({ id: newId, name: '', grade: students.length > 0 ? students[students.length-1].grade : 'أول ثانوي', attendance_log: {}, notes: '' });
            populateGradeFilter(); renderTable(); renderStats();
            setTimeout(() => { const inputs = document.querySelectorAll('input[placeholder="اسم الطالب"]'); if(inputs.length > 0) inputs[inputs.length - 1].focus(); }, 100);
        }
        function askToDeleteStudent(id) { 
            showDialog({ 
                title: 'حذف طالب', 
                message: 'هل أنت متأكد من حذف هذا الطالب؟', 
                type: 'danger', 
                isConfirm: true, 
                onConfirm: () => { 
                    students = students.filter(s => s.id !== id); 
                    saveData(); // Save deletion
                    populateGradeFilter(); 
                    renderTable(); 
                    renderStats(); 
                    showDialog({ title: 'تم الحذف', message: 'تم حذف الطالب بنجاح.', type: 'success' }); 
                } 
            }); 
        }
        function updateStudent(id, field, value) { const s = students.find(s => s.id === id); if (s) { s[field] = value; saveData(); if(field === 'grade') populateGradeFilter(); } }
        
        function askToClearData() { 
            showDialog({ 
                title: 'تصفير البيانات', 
                message: 'سيتم حذف جميع البيانات. هل أنت متأكد؟', 
                type: 'danger', 
                isConfirm: true, 
                onConfirm: () => { 
                    students = []; 
                    saveData(); // Save clear state
                    populateGradeFilter(); 
                    renderTable(); 
                    renderStats(); 
                    showDialog({ title: 'تم التصفير', message: 'تم حذف البيانات.', type: 'success' }); 
                } 
            }); 
        }

        function openStatusModal(id, slot) {
            currentEditingId = id; currentEditingSlot = slot; const dateKey = getTodayKey(), s = students.find(s => s.id === id);
            document.getElementById('modal-student-name').innerText = s ? s.name : ''; document.getElementById('modal-date-display').innerText = dateKey; document.getElementById('modal-slot-number').innerText = slot;
            const entry = s.attendance_log[`${dateKey}_slot_${slot}`], panel = document.getElementById('modal-current-status-section');
            if (entry && entry.status) {
                const config = statusTypes[entry.status] || statusTypes['none'], count = entry.count || 1;
                panel.classList.remove('hidden');
                document.getElementById('modal-current-status-display').innerHTML = `<div class="px-2 py-1 rounded bg-white border border-gray-200 shadow-sm flex items-center gap-2"><i class="fas ${config.icon} ${config.color}"></i><span class="text-sm font-bold text-gray-700">${config.label}</span>${count > 1 ? `<span class="bg-red-500 text-white text-[10px] px-1.5 rounded-full font-bold">x${count}</span>` : ''}</div>`;
                document.getElementById('btn-decrement').classList.toggle('hidden', count <= 1);
            } else { panel.classList.add('hidden'); }
            const modal = document.getElementById('status-modal'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.add('scale-100'); }, 10);
        }
        function closeModal() { const modal = document.getElementById('status-modal'); modal.classList.add('opacity-0'); setTimeout(() => { modal.classList.add('hidden'); currentEditingId = null; }, 200); }
        function setStatus(key) {
            if (currentEditingId !== null) {
                const s = students.find(s => s.id === currentEditingId), compKey = `${getTodayKey()}_slot_${currentEditingSlot}`, entry = s.attendance_log[compKey];
                if (entry && entry.status === key) { entry.count = (entry.count || 1) + 1; }
                else if (entry && (entry.count || 1) > 1) {
                    return showDialog({ title: 'تأكيد', message: `هل تريد استبدال الحالة الحالية وتصفير العداد؟`, type: 'danger', isConfirm: true, onConfirm: () => { s.attendance_log[compKey] = { status: key, count: 1 }; saveData(); renderTable(); renderStats(); closeModal(); } });
                } else { s.attendance_log[compKey] = { status: key, count: 1 }; }
                saveData(); renderTable(); renderStats(); closeModal();
            }
        }
        function decrementCurrentStatus() { const s = students.find(s => s.id === currentEditingId), entry = s.attendance_log[`${getTodayKey()}_slot_${currentEditingSlot}`]; if (entry && entry.count > 1) { entry.count--; saveData(); renderTable(); renderStats(); openStatusModal(currentEditingId, currentEditingSlot); } }
        function clearCurrentStatus() { const s = students.find(s => s.id === currentEditingId); delete s.attendance_log[`${getTodayKey()}_slot_${currentEditingSlot}`]; saveData(); renderTable(); renderStats(); closeModal(); }

        function openSettingsModal() { 
            applyTheme(); 
            applyStatsVisibility(); 
            renderLogoSettings(); // Update Logo UI
            
            // Populate School Settings
            document.getElementById('setting-school-name').value = schoolName;
            document.getElementById('setting-principal-name').value = principalName;
            document.getElementById('setting-teacher-name').value = teacherName;

            const m = document.getElementById('settings-modal'); 
            m.classList.remove('hidden'); 
            setTimeout(() => { m.classList.remove('opacity-0'); m.firstElementChild.classList.add('scale-100'); }, 10); 
        }
        function closeSettingsModal() { const m = document.getElementById('settings-modal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 200); }
        
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(students)); a.download = `pe_students_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); closeSettingsModal(); showDialog({ title: 'نجاح', message: 'تم تحميل النسخة الاحتياطية.', type: 'success' }); }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(Array.isArray(d)) { showDialog({ title: 'تأكيد الاستيراد', message: `تم العثور على ${d.length} طالب. استبدال البيانات؟`, type: 'info', isConfirm: true, onConfirm: () => { students = d; saveData(); init(); closeSettingsModal(); showDialog({ title: 'تم', message: 'تم الاستيراد بنجاح.', type: 'success' }); } }); } } catch(err) { showDialog({ title: 'خطأ', message: 'فشل قراءة الملف.', type: 'danger' }); } input.value = ''; }; r.readAsText(file);
        }
        function importNamesFromText(input) {
            const file = input.files[0]; if (!file) return;
            const r = new FileReader(); r.onload = e => { pendingImportNames = e.target.result.split(/\r?\n/).map(n => n.trim()).filter(n => n.length > 0); if(pendingImportNames.length){ closeSettingsModal(); openGradeModal(pendingImportNames.length); } else { showDialog({ title: 'تنبيه', message: 'لا توجد أسماء.', type: 'danger' }); } input.value = ''; }; r.readAsText(file);
        }
        function openGradeModal(c) { document.getElementById('imported-count').innerText = c; document.getElementById('import-grade-input').value = ''; const m = document.getElementById('grade-selection-modal'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.firstElementChild.classList.add('scale-100'); document.getElementById('import-grade-input').focus(); }, 10); }
        function closeGradeModal() { const m = document.getElementById('grade-selection-modal'); m.classList.add('opacity-0'); setTimeout(() => { m.classList.add('hidden'); pendingImportNames = []; }, 200); }
        function confirmImportNames() {
            const g = document.getElementById('import-grade-input').value.trim(); if (!g) return;
            let max = students.length > 0 ? Math.max(...students.map(s => s.id)) : 0;
            const newS = pendingImportNames.map(n => ({ id: ++max, name: n, grade: g, attendance_log: {}, notes: '' }));
            students = [...students, ...newS]; saveData(); populateGradeFilter(); renderTable(); renderStats(); closeGradeModal(); showDialog({ title: 'تم بنجاح', message: `تم إضافة ${newS.length} طالب.`, type: 'success' });
        }
        function saveData() { localStorage.setItem('pe_students', JSON.stringify(students)); }

        // --- New Edit Logic ---
        function openEditStudentModal(id) { const s = students.find(s => s.id === id); if(s){ document.getElementById('edit-student-id').value = s.id; document.getElementById('edit-student-name').value = s.name; document.getElementById('edit-student-grade').value = s.grade; const m = document.getElementById('edit-student-modal'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.firstElementChild.classList.add('scale-100'); }, 10); } }
        function closeEditStudentModal() { const m = document.getElementById('edit-student-modal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 200); }
        function saveStudentDetails() { const id = parseInt(document.getElementById('edit-student-id').value), s = students.find(s => s.id === id); if(s){ s.name = document.getElementById('edit-student-name').value; s.grade = document.getElementById('edit-student-grade').value; saveData(); populateGradeFilter(); renderTable(); closeEditStudentModal(); } }

        // Listeners
        document.getElementById('status-modal').addEventListener('click', function(e){ if(e.target===this) closeModal(); });
        document.getElementById('settings-modal').addEventListener('click', function(e){ if(e.target===this) closeSettingsModal(); });
        document.getElementById('custom-dialog-modal').addEventListener('click', function(e){ if(e.target===this) closeDialog(); });
        document.getElementById('grade-selection-modal').addEventListener('click', function(e){ if(e.target===this) closeGradeModal(); });
        document.getElementById('history-modal').addEventListener('click', function(e){ if(e.target===this) closeHistoryModal(); });
        document.getElementById('status-manager-modal').addEventListener('click', function(e){ if(e.target===this) closeStatusManager(); });
        document.getElementById('edit-student-modal').addEventListener('click', function(e){ if(e.target===this) closeEditStudentModal(); });

        init();
    </script>
<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('service-worker.js').catch(console.error); }); }
let deferredPrompt = null; const installBar = document.getElementById('installBar'), installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (installBar) installBar.style.display = 'flex'; });
if (installBtn) installBtn.addEventListener('click', async () => { if (!deferredPrompt) return; installBtn.disabled = true; await deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if (installBar) installBar.style.display = 'none'; });
window.addEventListener('appinstalled', () => { deferredPrompt = null; if (installBar) installBar.style.display = 'none'; });
</script>
</body>
</html>