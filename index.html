<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متابعة الطلاب - تربية بدنية</title>
    <meta name="theme-color" content="#0ea5e9" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#107C41',
                        dark: { bg: '#111827', card: '#1f2937', border: '#374151', text: '#f3f4f6' }
                    },
                    fontFamily: { cairo: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .status-circle { transition: all 0.2s; cursor: pointer; }
        .status-circle:hover { transform: scale(1.15); z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .student-card { transition: transform 0.2s; }
        .student-card:hover { transform: translateY(-2px); }
        
        /* Selectors Styling */
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: #333; transform: scale(1.2); box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; transition: all 0.2s; }
        .icon-option:hover { background-color: #f3f4f6; }
        .icon-option.selected { background-color: #107C41; color: white; border-color: #107C41; }

        /* Print/PDF Area Styling */
        #print-area {
            display: none;
            background: white;
            color: black;
            direction: rtl;
            font-family: 'Cairo', sans-serif;
            padding: 20px;
            width: 100%;
        }
        .rpt-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
        .rpt-header-col { width: 30%; text-align: center; }
        .rpt-doc-title { text-align: center; font-size: 20px; font-weight: 800; margin: 20px 0; text-decoration: underline; }
        .rpt-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        .rpt-table th { background-color: #eee; border: 1px solid #000; padding: 8px; text-align: center; }
        .rpt-table td { border: 1px solid #000; padding: 6px; text-align: center; }
        .rpt-info-box { border: 1px solid #000; padding: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; background-color: #f9f9f9; }
        .rpt-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .rpt-stat-card { border: 1px solid #000; padding: 8px; text-align: center; border-radius: 4px; }
        .rpt-footer { margin-top: 40px; display: flex; justify-content: space-between; }
        .rpt-sig-box { width: 30%; text-align: center; }
        .rpt-sig-line { border-top: 1px solid #000; width: 80%; margin: 40px auto 0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen p-3 md:p-6 transition-colors duration-300">

    <div class="max-w-[1400px] mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-t-4 border-primary">
            <div class="flex items-center gap-4">
                <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-xl">
                    <i class="fas fa-users-rectangle text-primary text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">سجل متابعة الطلاب</h1>
                    <p class="text-xs text-gray-500 font-semibold mt-1">نظام البطاقات الذكي</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex flex-wrap justify-center gap-2">
                <button onclick="addNewStudent()" class="bg-primary hover:bg-green-800 text-white px-4 py-2 rounded-xl shadow font-bold text-sm">
                    <i class="fas fa-plus"></i> إضافة طالب
                </button>
                <button onclick="generateClassReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow font-bold text-sm flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button onclick="askToClearData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl shadow font-bold text-sm">
                    <i class="fas fa-trash"></i> تصفير
                </button>
                <button onclick="openSettingsModal()" class="bg-gray-700 text-white px-4 py-2 rounded-xl shadow">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6" id="stats-container"></div>

        <div class="mb-6 flex flex-col md:flex-row gap-3">
            <div class="relative flex-grow">
                <input type="text" oninput="handleSearch(this.value)" class="block w-full p-3 pr-10 text-sm border rounded-xl dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="بحث عن طالب...">
                <i class="fas fa-search absolute top-3.5 right-3 text-gray-400"></i>
            </div>
            <div class="w-full md:w-1/4">
                <select id="grade-filter" onchange="handleGradeFilter(this.value)" class="block w-full p-3 text-sm border rounded-xl dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                    <option value="all">عرض كل الصفوف</option>
                </select>
            </div>
        </div>

        <div id="students-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 pb-20"></div>
        
        <div id="empty-state" class="hidden text-center py-20 text-gray-400">
            <i class="fas fa-address-card text-5xl mb-4"></i>
            <p>لا يوجد طلاب مطابقين.</p>
        </div>
    </div>

    <div id="print-area"></div>

    <div id="status-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-3xl overflow-hidden">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50">
                <h3 class="font-bold text-lg dark:text-white">رصد الحالة: <span id="modal-student-name" class="text-primary"></span></h3>
                <button onclick="closeModal()"><i class="fas fa-times text-gray-400 hover:text-red-500 text-xl"></i></button>
            </div>
            <div class="p-6 grid grid-cols-2 sm:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto" id="status-options-grid"></div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg dark:text-white">سجل الحضور: <span id="history-student-name" class="text-blue-600"></span></h3>
                <div class="flex gap-2">
                    <button onclick="generateIndividualReport(currentHistoryStudentId)" class="bg-blue-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button onclick="closeHistoryModal()"><i class="fas fa-times text-gray-400"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto">
                <table class="w-full text-sm text-right"><tbody id="history-table-body"></tbody></table>
                <div id="history-empty" class="hidden text-center py-10 text-gray-400">لا يوجد سجلات.</div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6">
            <div class="flex justify-between mb-4">
                <h3 class="font-bold text-lg dark:text-white">الإعدادات</h3>
                <button onclick="closeSettingsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div onclick="openStatusManager()" class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-800 flex justify-between items-center cursor-pointer hover:bg-amber-100 dark:hover:bg-amber-900/30 transition">
                    <div class="flex items-center gap-3">
                        <div class="bg-amber-100 dark:bg-amber-900/40 text-amber-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-list-check"></i></div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white text-sm">إدارة الحالات</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-300">إضافة أو حذف أو تعديل الحالات</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400"></i>
                </div>

                <hr class="dark:border-gray-700">

                <button onclick="exportData()" class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-bold">تصدير نسخة احتياطية (JSON)</button>
                <button onclick="document.getElementById('import-file').click()" class="w-full bg-green-100 text-green-700 py-3 rounded-lg font-bold">استيراد نسخة احتياطية</button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                <button onclick="document.getElementById('import-txt-file').click()" class="w-full bg-orange-100 text-orange-700 py-3 rounded-lg font-bold">استيراد أسماء من ملف نصي</button>
                <input type="file" id="import-txt-file" accept=".txt" class="hidden" onchange="importNamesFromText(this)">
                <div class="flex justify-between items-center pt-4 border-t dark:border-gray-700">
                    <span class="dark:text-white">الوضع الداكن</span>
                    <button onclick="toggleTheme()" class="bg-gray-200 dark:bg-purple-600 h-6 w-11 rounded-full relative"><span class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all" id="theme-toggle-circle" style="left:4px"></span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="status-manager-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 shrink-0">
                <h3 class="font-bold text-lg dark:text-white"><i class="fas fa-list-check text-amber-600 ml-2"></i>إدارة الحالات</h3>
                <button onclick="closeStatusManager()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-200 dark:border-gray-700 mb-6">
                    <h4 class="font-bold text-sm mb-3 dark:text-white">إضافة حالة جديدة</h4>
                    <div class="space-y-3">
                        <input type="text" id="new-status-name" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="اسم الحالة (مثال: نسيان زي)">
                        
                        <div>
                            <p class="text-xs text-gray-500 mb-2">اختر لون:</p>
                            <div class="flex gap-2 flex-wrap" id="color-picker-container"></div>
                            <input type="hidden" id="selected-color-key">
                        </div>

                        <div>
                            <p class="text-xs text-gray-500 mb-2">اختر أيقونة:</p>
                            <div class="grid grid-cols-6 gap-2" id="icon-picker-container"></div>
                            <input type="hidden" id="selected-icon-class">
                        </div>

                        <label class="flex items-center gap-2 text-sm dark:text-white cursor-pointer">
                            <input type="checkbox" id="new-status-stats" checked class="w-4 h-4 text-primary">
                            تظهر في شريط الإحصائيات
                        </label>

                        <button onclick="addNewStatusType()" class="bg-primary hover:bg-green-700 text-white w-full py-2 rounded font-bold text-sm">إضافة</button>
                    </div>
                </div>

                <h4 class="font-bold text-sm mb-3 dark:text-white border-b pb-2 dark:border-gray-700">الحالات الحالية</h4>
                <div id="status-list-container" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div id="edit-student-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4 dark:text-white">تعديل بيانات الطالب</h3>
            <input type="text" id="edit-student-name" class="w-full p-2 border rounded mb-3 dark:bg-gray-700 dark:text-white">
            <input type="text" id="edit-student-grade" class="w-full p-2 border rounded mb-3 dark:bg-gray-700 dark:text-white">
            <input type="hidden" id="edit-student-id">
            <div class="flex justify-end gap-2">
                <button onclick="closeEditStudentModal()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
                <button onclick="saveStudentDetails()" class="bg-blue-600 text-white px-4 py-2 rounded">حفظ</button>
            </div>
        </div>
    </div>

    <div id="grade-selection-modal" class="fixed inset-0 bg-gray-900/60 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-2 dark:text-white">تحديد الصف</h3>
            <p class="mb-4 text-sm text-gray-500">تم العثور على <span id="imported-count" class="font-bold"></span> اسم.</p>
            <input type="text" id="import-grade-input" class="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" placeholder="مثال: ثاني ثانوي (أ)">
            <div class="flex justify-end gap-2">
                <button onclick="closeGradeModal()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
                <button onclick="confirmImportNames()" class="bg-orange-600 text-white px-4 py-2 rounded">حفظ واستيراد</button>
            </div>
        </div>
    </div>

    <div id="custom-dialog-modal" class="fixed inset-0 bg-gray-900/70 hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
            <i id="custom-dialog-icon" class="text-4xl mb-4 block"></i>
            <h3 id="custom-dialog-title" class="font-bold text-xl mb-2 dark:text-white"></h3>
            <p id="custom-dialog-message" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            <div id="custom-dialog-actions" class="flex justify-center gap-3"></div>
        </div>
    </div>

    <script>
        // --- Data & Config ---
        const DEFAULT_STATUS_TYPES = {
            'none': { label: 'لم يرصد', icon: 'fa-circle', color: 'text-gray-300', bg: 'bg-gray-100', stats: false },
            'present_kit': { label: 'حاضر (زي)', icon: 'fa-tshirt', color: 'text-green-600', bg: 'bg-green-100', stats: true },
            'present_no_kit': { label: 'حاضر (لا زي)', icon: 'fa-user-tie', color: 'text-orange-600', bg: 'bg-orange-100', stats: true },
            'participating': { label: 'مشارك', icon: 'fa-star', color: 'text-yellow-500', bg: 'bg-yellow-50', stats: true },
            'absent': { label: 'غائب', icon: 'fa-user-xmark', color: 'text-red-600', bg: 'bg-red-100', stats: true },
            'excused': { label: 'مستأذن', icon: 'fa-file-signature', color: 'text-blue-600', bg: 'bg-blue-100', stats: true },
            'sick': { label: 'مريض', icon: 'fa-truck-medical', color: 'text-pink-600', bg: 'bg-pink-100', stats: true },
            'disruptive': { label: 'مشاغب', icon: 'fa-bolt', color: 'text-purple-600', bg: 'bg-purple-100', stats: true }
        };

        // Predefined Colors for Manager
        const STATUS_COLORS = {
            'green': { color: 'text-green-600', bg: 'bg-green-100', display: '#16a34a' },
            'red': { color: 'text-red-600', bg: 'bg-red-100', display: '#dc2626' },
            'blue': { color: 'text-blue-600', bg: 'bg-blue-100', display: '#2563eb' },
            'yellow': { color: 'text-yellow-500', bg: 'bg-yellow-50', display: '#eab308' },
            'orange': { color: 'text-orange-600', bg: 'bg-orange-100', display: '#ea580c' },
            'purple': { color: 'text-purple-600', bg: 'bg-purple-100', display: '#9333ea' },
            'pink': { color: 'text-pink-600', bg: 'bg-pink-100', display: '#db2777' },
            'gray': { color: 'text-gray-600', bg: 'bg-gray-200', display: '#4b5563' },
            'indigo': { color: 'text-indigo-600', bg: 'bg-indigo-100', display: '#4f46e5' },
            'teal': { color: 'text-teal-600', bg: 'bg-teal-100', display: '#0d9488' },
            'black': { color: 'text-gray-800', bg: 'bg-gray-300', display: '#000000' }
        };

        const STATUS_ICONS = [
            'fa-circle', 'fa-check', 'fa-times', 'fa-star', 'fa-user', 'fa-user-clock', 
            'fa-heart', 'fa-thumbs-up', 'fa-thumbs-down', 'fa-exclamation', 'fa-question', 
            'fa-trophy', 'fa-medal', 'fa-bolt', 'fa-ban', 'fa-running', 'fa-football-ball', 
            'fa-basketball-ball', 'fa-stopwatch', 'fa-shoe-prints', 'fa-bullhorn', 'fa-clipboard'
        ];

        let statusTypes = JSON.parse(localStorage.getItem('pe_status_types')) || DEFAULT_STATUS_TYPES;
        let students = JSON.parse(localStorage.getItem('pe_students')) || [];
        
        students = students.map(s => {
            if(!s.attendance_log) s.attendance_log = {};
            if(!s.notes) s.notes = '';
            for (const key in s.attendance_log) {
                if (typeof s.attendance_log[key] === 'string') {
                    s.attendance_log[key] = { status: s.attendance_log[key], count: 1 };
                }
            }
            return s;
        });

        let currentEditingId = null, currentEditingSlot = null;
        let currentSearchTerm = '', currentFilterGrade = 'all';
        let currentHistoryStudentId = null;
        let isDarkMode = localStorage.getItem('pe_dark_mode') === 'true';
        let pendingImportNames = [];

        function init() {
            applyTheme();
            populateGradeFilter();
            renderTable();
            renderStats();
            renderModalOptions();
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function exportHTMLToPDF(htmlContent, fileName) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = htmlContent;
            printArea.style.display = 'block';

            const opt = {
                margin: [5, 5, 5, 5],
                filename: fileName + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const activeBtn = document.activeElement;
            const originalText = activeBtn ? activeBtn.innerHTML : '';
            if(activeBtn) activeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التصدير...';

            html2pdf().set(opt).from(printArea).save().then(() => {
                printArea.innerHTML = '';
                printArea.style.display = 'none';
                if(activeBtn) activeBtn.innerHTML = originalText;
                showDialog({ title: 'تم', message: 'تم حفظ ملف PDF بنجاح.', type: 'success' });
            }).catch(err => {
                console.error(err);
                printArea.style.display = 'none';
                if(activeBtn) activeBtn.innerHTML = originalText;
                showDialog({ title: 'خطأ', message: 'حدث خطأ أثناء التصدير.', type: 'danger' });
            });
        }

        function getReportHeader(title) {
            const date = new Date().toLocaleDateString('ar-SA');
            return `
                <div class="rpt-header">
                    <div class="rpt-header-col" style="text-align:right">
                        <div>المملكة العربية السعودية</div>
                        <div>وزارة التعليم</div>
                        <div>مدرسة .........................</div>
                    </div>
                    <div class="rpt-header-col"><i class="fas fa-running" style="font-size:40px;color:#107C41"></i></div>
                    <div class="rpt-header-col" style="text-align:left">
                        <div><b>التاريخ:</b> ${date}</div>
                    </div>
                </div>
                <div class="rpt-doc-title">${title}</div>
            `;
        }

        function getReportFooter() {
            return `
                <div class="rpt-footer">
                    <div class="rpt-sig-box"><p>معلم التربية البدنية</p><div class="rpt-sig-line"></div></div>
                    <div class="rpt-sig-box"><p>وكيل الشؤون الطلابية</p><div class="rpt-sig-line"></div></div>
                    <div class="rpt-sig-box"><p>مدير المدرسة</p><div class="rpt-sig-line"></div></div>
                </div>
            `;
        }

        function generateClassReport() {
            if (students.length === 0) return showDialog({ title: 'تنبيه', message: 'لا يوجد بيانات.', type: 'danger' });
            const gradeName = currentFilterGrade !== 'all' ? currentFilterGrade : 'جميع الصفوف';
            let html = getReportHeader('كشف متابعة - ' + gradeName);
            html += `
                <table class="rpt-table"><thead><tr>
                    <th width="5%">#</th><th width="35%">الاسم</th><th width="15%">الصف</th><th width="30%">الملخص</th><th width="15%">آخر حالة</th>
                </tr></thead><tbody>`;

            const filtered = students.filter(s => currentFilterGrade === 'all' || s.grade === currentFilterGrade);
            if(filtered.length === 0) html += `<tr><td colspan="5">لا توجد بيانات</td></tr>`;

            filtered.forEach((s, i) => {
                let statsStr = [];
                const logs = Object.values(s.attendance_log);
                const counts = {};
                logs.forEach(v => {
                    const st = v.status || v; const c = v.count || 1;
                    if(statusTypes[st]?.stats) counts[st] = (counts[st]||0) + c;
                });
                // Sort by importance (status key)
                Object.keys(counts).forEach(k => {
                   if(statusTypes[k]) statsStr.push(`${statusTypes[k].label}: ${counts[k]}`);
                });

                let lastStatus = '-';
                const logEntries = Object.entries(s.attendance_log).sort((a,b) => b[0].localeCompare(a[0]));
                if(logEntries.length) {
                    const k = logEntries[0][1].status || logEntries[0][1];
                    lastStatus = statusTypes[k]?.label || '-';
                }

                html += `<tr><td>${i+1}</td><td style="text-align:right;font-weight:bold">${s.name}</td><td>${s.grade}</td><td>${statsStr.join(' | ')}</td><td>${lastStatus}</td></tr>`;
            });
            html += `</tbody></table>` + getReportFooter();
            exportHTMLToPDF(html, `تقرير_${gradeName.replace(/\s/g,'_')}`);
        }

        function generateIndividualReport(id) {
            const s = students.find(x => x.id === id);
            if(!s) return;
            let html = getReportHeader('سجل الطالب التفصيلي');
            html += `<div class="rpt-info-box"><div><b>الاسم:</b> ${s.name}</div><div><b>الصف:</b> ${s.grade}</div></div>`;
            
            const logs = Object.entries(s.attendance_log).sort((a,b) => b[0].localeCompare(a[0]));
            // Dynamic Stats for Report
            const counts = {};
            logs.forEach(([,v]) => {
                const st = v.status || v; const c = v.count || 1;
                if(statusTypes[st]) counts[st] = (counts[st]||0) + c;
            });

            html += `<div class="rpt-stats-grid">`;
            Object.entries(counts).forEach(([k,v]) => {
                if(statusTypes[k]) html += `<div class="rpt-stat-card"><b>${v}</b><br>${statusTypes[k].label}</div>`;
            });
            html += `</div><table class="rpt-table"><thead><tr><th>التاريخ</th><th>الخانة</th><th>الحالة</th></tr></thead><tbody>`;

            logs.forEach(([k, v]) => {
                const stKey = v.status || v; const count = v.count || 1;
                const conf = statusTypes[stKey] || statusTypes['none'];
                let date = k.split('_slot_')[0];
                let slot = k.includes('_slot_') ? k.split('_slot_')[1] : '-';
                html += `<tr><td>${date}</td><td>${slot}</td><td>${conf.label} ${count>1?`(x${count})`:''}</td></tr>`;
            });
            html += `</tbody></table>` + getReportFooter();
            exportHTMLToPDF(html, `سجل_${s.name.replace(/\s/g,'_')}`);
        }

        function applyTheme() {
            if(isDarkMode) { document.documentElement.classList.add('dark'); document.getElementById('theme-toggle-circle').style.left = '24px'; }
            else { document.documentElement.classList.remove('dark'); document.getElementById('theme-toggle-circle').style.left = '4px'; }
        }
        function toggleTheme() { isDarkMode = !isDarkMode; localStorage.setItem('pe_dark_mode', isDarkMode); applyTheme(); }

        function saveData() { localStorage.setItem('pe_students', JSON.stringify(students)); }
        function saveStatusTypes() { localStorage.setItem('pe_status_types', JSON.stringify(statusTypes)); }

        function renderTable() {
            const container = document.getElementById('students-container');
            const emptyState = document.getElementById('empty-state');
            container.innerHTML = '';
            
            const filtered = students.filter(s => {
                return s.name.includes(currentSearchTerm) && (currentFilterGrade === 'all' || s.grade === currentFilterGrade);
            });

            if(filtered.length === 0) {
                container.classList.add('hidden'); emptyState.classList.remove('hidden');
            } else {
                container.classList.remove('hidden'); emptyState.classList.add('hidden');
                const today = getTodayKey();
                
                filtered.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'student-card bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 overflow-hidden';
                    
                    let circles = '<div class="p-4 grid grid-cols-5 gap-2">';
                    for(let i=1; i<=10; i++) {
                        const key = `${today}_slot_${i}`;
                        const entry = s.attendance_log[key];
                        const stKey = entry ? entry.status : 'none';
                        const count = entry ? (entry.count || 1) : 1;
                        const conf = statusTypes[stKey] || statusTypes['none']; // Fallback
                        
                        circles += `
                            <div class="flex flex-col items-center relative">
                                <div onclick="openStatusModal(${s.id},${i})" class="status-circle w-10 h-10 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-600 ${conf.bg} ${conf.color}">
                                    <i class="fas ${conf.icon}"></i>
                                    ${count > 1 ? `<span class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center">${count}</span>` : ''}
                                </div>
                                <span class="text-[10px] text-gray-400 font-mono mt-1">${i}</span>
                            </div>`;
                    }
                    circles += '</div>';

                    div.innerHTML = `
                        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 flex justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">${s.name[0]}</div>
                                <div><h3 class="font-bold text-sm dark:text-white">${s.name}</h3><p class="text-xs text-gray-500">${s.grade}</p></div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="openEditStudentModal(${s.id})" class="text-gray-400 hover:text-gray-600 p-1"><i class="fas fa-pen"></i></button>
                                <button onclick="openHistoryModal(${s.id})" class="text-blue-400 hover:text-blue-600 p-1"><i class="fas fa-history"></i></button>
                                <button onclick="askToDelete(${s.id})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${circles}
                        <div class="p-3"><input type="text" value="${s.notes}" onchange="updateNote(${s.id},this.value)" class="w-full bg-gray-50 dark:bg-gray-900 border rounded p-2 text-xs" placeholder="ملاحظات..."></div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function renderStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '';
            const counts = {};
            const today = getTodayKey();
            
            Object.keys(statusTypes).forEach(k => { if(statusTypes[k].stats) counts[k] = 0; });
            
            students.forEach(s => {
                if(currentFilterGrade !== 'all' && s.grade !== currentFilterGrade) return;
                for(let i=1; i<=10; i++) {
                    const entry = s.attendance_log[`${today}_slot_${i}`];
                    if(entry && statusTypes[entry.status]?.stats) counts[entry.status] += (entry.count || 1);
                }
            });

            Object.entries(counts).forEach(([k, v]) => {
                if(v > 0) {
                    const c = statusTypes[k];
                    container.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow border-r-4 ${c.color.replace('text','border')} flex justify-between items-center">
                            <div><span class="text-[10px] text-gray-500">${c.label}</span><span class="block text-xl font-bold ${c.color}">${v}</span></div>
                            <i class="fas ${c.icon} ${c.color} opacity-50"></i>
                        </div>`;
                }
            });
        }

        function renderModalOptions() {
            const grid = document.getElementById('status-options-grid');
            grid.innerHTML = '';
            Object.entries(statusTypes).forEach(([k, conf]) => {
                if(k === 'none') return;
                const btn = document.createElement('button');
                btn.className = `flex flex-col items-center p-3 rounded-xl border ${conf.bg} hover:brightness-95 transition`;
                btn.onclick = () => setStatus(k);
                btn.innerHTML = `<i class="fas ${conf.icon} text-2xl mb-2 ${conf.color}"></i><span class="text-xs font-bold dark:text-gray-700">${conf.label}</span>`;
                grid.appendChild(btn);
            });
        }

        // --- Status Manager Logic ---
        function openStatusManager() {
            closeSettingsModal();
            renderStatusList();
            renderColorPicker();
            renderIconPicker();
            document.getElementById('status-manager-modal').classList.remove('hidden');
        }
        function closeStatusManager() {
            document.getElementById('status-manager-modal').classList.add('hidden');
            openSettingsModal();
        }
        function renderStatusList() {
            const c = document.getElementById('status-list-container');
            c.innerHTML = '';
            Object.entries(statusTypes).forEach(([k, conf]) => {
                if(k==='none') return;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white dark:bg-gray-800 p-2 rounded border dark:border-gray-700';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${conf.bg} ${conf.color}"><i class="fas ${conf.icon}"></i></div>
                        <span class="text-sm font-bold dark:text-white">${conf.label}</span>
                        ${conf.stats?'<span class="text-[10px] bg-green-100 text-green-700 px-2 rounded">إحصاء</span>':''}
                    </div>
                    <button onclick="deleteStatusType('${k}')" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fas fa-trash"></i></button>
                `;
                c.appendChild(div);
            });
        }
        function renderColorPicker() {
            const c = document.getElementById('color-picker-container');
            c.innerHTML = '';
            Object.entries(STATUS_COLORS).forEach(([k, v]) => {
                const s = document.createElement('div');
                s.className = 'color-swatch'; s.style.backgroundColor = v.display;
                s.onclick = () => {
                    document.querySelectorAll('.color-swatch').forEach(e=>e.classList.remove('selected'));
                    s.classList.add('selected');
                    document.getElementById('selected-color-key').value = k;
                };
                c.appendChild(s);
            });
            c.firstChild.click();
        }
        function renderIconPicker() {
            const c = document.getElementById('icon-picker-container');
            c.innerHTML = '';
            STATUS_ICONS.forEach(icon => {
                const i = document.createElement('div');
                i.className = 'icon-option'; i.innerHTML = `<i class="fas ${icon}"></i>`;
                i.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(e=>e.classList.remove('selected'));
                    i.classList.add('selected');
                    document.getElementById('selected-icon-class').value = icon;
                };
                c.appendChild(i);
            });
            c.firstChild.click();
        }
        function addNewStatusType() {
            const name = document.getElementById('new-status-name').value.trim();
            const colorKey = document.getElementById('selected-color-key').value;
            const icon = document.getElementById('selected-icon-class').value;
            const stats = document.getElementById('new-status-stats').checked;
            
            if(!name) return alert('اكتب اسم الحالة');
            
            const id = 'status_' + Date.now();
            const colorConf = STATUS_COLORS[colorKey] || STATUS_COLORS['gray'];
            
            statusTypes[id] = { label: name, icon: icon, color: colorConf.color, bg: colorConf.bg, stats: stats };
            saveStatusTypes();
            renderStatusList();
            renderTable(); renderStats(); renderModalOptions();
            document.getElementById('new-status-name').value = '';
        }
        function deleteStatusType(key) {
            if(confirm('حذف هذه الحالة؟')) {
                delete statusTypes[key];
                saveStatusTypes();
                renderStatusList();
                renderTable(); renderStats(); renderModalOptions();
            }
        }

        // --- Interaction Logic ---
        function handleSearch(v) { currentSearchTerm = v; renderTable(); }
        function handleGradeFilter(v) { currentFilterGrade = v; renderTable(); renderStats(); }
        function populateGradeFilter() {
            const sel = document.getElementById('grade-filter');
            const grades = [...new Set(students.map(s => s.grade))].sort();
            sel.innerHTML = '<option value="all">عرض كل الصفوف</option>';
            grades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g; opt.innerText = g;
                if(g === currentFilterGrade) opt.selected = true;
                sel.appendChild(opt);
            });
        }
        
        function addNewStudent() {
            const id = students.length ? Math.max(...students.map(s=>s.id))+1 : 1;
            students.push({ id, name: '', grade: 'أول ثانوي', attendance_log: {}, notes: '' });
            populateGradeFilter(); renderTable();
            setTimeout(() => document.querySelectorAll('input[placeholder="ملاحظات..."]')[students.length-1].parentElement.parentElement.querySelector('h3').scrollIntoView(), 100);
        }

        function askToDelete(id) {
            showDialog({
                title: 'حذف طالب', message: 'هل أنت متأكد؟', type: 'danger', isConfirm: true,
                onConfirm: () => { students = students.filter(s => s.id !== id); saveData(); renderTable(); renderStats(); populateGradeFilter(); }
            });
        }

        function updateNote(id, val) {
            const s = students.find(x => x.id === id);
            if(s) { s.notes = val; saveData(); }
        }

        function openStatusModal(id, slot) {
            currentEditingId = id; currentEditingSlot = slot;
            const s = students.find(x => x.id === id);
            document.getElementById('modal-student-name').innerText = s.name;
            document.getElementById('status-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('status-modal').classList.add('hidden'); }

        function setStatus(statusKey) {
            if(currentEditingId && currentEditingSlot) {
                const s = students.find(x => x.id === currentEditingId);
                const key = `${getTodayKey()}_slot_${currentEditingSlot}`;
                const current = s.attendance_log[key];

                if(current && current.status === statusKey) {
                    current.count = (current.count || 1) + 1;
                } else if(current && (current.count||1) > 1) {
                    if(!confirm('هذه الخانة مكررة. هل تريد استبدالها وتصفير العداد؟')) return;
                    s.attendance_log[key] = { status: statusKey, count: 1 };
                } else {
                    s.attendance_log[key] = { status: statusKey, count: 1 };
                }
                saveData(); renderTable(); renderStats(); closeModal();
            }
        }

        function openHistoryModal(id) {
            currentHistoryStudentId = id;
            const s = students.find(x => x.id === id);
            document.getElementById('history-student-name').innerText = s.name;
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            const logs = Object.entries(s.attendance_log).sort((a,b) => b[0].localeCompare(a[0]));
            
            if(!logs.length) {
                document.getElementById('history-empty').classList.remove('hidden');
            } else {
                document.getElementById('history-empty').classList.add('hidden');
                logs.forEach(([k, v]) => {
                    const st = v.status || v; const c = v.count || 1;
                    const conf = statusTypes[st] || statusTypes.none;
                    let date = k.split('_slot_')[0];
                    let slot = k.includes('_slot_') ? `الخانة ${k.split('_slot_')[1]}` : 'عام';
                    tbody.innerHTML += `
                        <tr class="border-b dark:border-gray-700">
                            <td class="p-3">${date}</td><td class="p-3">${slot}</td>
                            <td class="p-3"><span class="${conf.bg} ${conf.color} px-2 py-1 rounded text-xs font-bold">${conf.label} ${c>1?`(x${c})`:''}</span></td>
                        </tr>`;
                });
            }
            document.getElementById('history-modal').classList.remove('hidden');
        }
        function closeHistoryModal() { document.getElementById('history-modal').classList.add('hidden'); }

        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(students));
            a.download = `pe_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        function importData(input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    students = data; saveData(); init(); closeSettingsModal();
                    showDialog({title:'نجاح', message:'تم استرجاع البيانات', type:'success'});
                }
            };
            if(input.files[0]) fr.readAsText(input.files[0]);
        }
        function importNamesFromText(input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                pendingImportNames = e.target.result.split('\n').map(x=>x.trim()).filter(x=>x);
                if(pendingImportNames.length) {
                    closeSettingsModal();
                    document.getElementById('imported-count').innerText = pendingImportNames.length;
                    document.getElementById('grade-selection-modal').classList.remove('hidden');
                }
            };
            if(input.files[0]) fr.readAsText(input.files[0]);
        }
        function closeGradeModal() { document.getElementById('grade-selection-modal').classList.add('hidden'); }
        function confirmImportNames() {
            const grade = document.getElementById('import-grade-input').value;
            if(!grade) return alert('الرجاء كتابة الصف');
            let maxId = students.length ? Math.max(...students.map(s=>s.id)) : 0;
            pendingImportNames.forEach(name => {
                students.push({ id: ++maxId, name, grade, attendance_log: {}, notes: '' });
            });
            saveData(); init(); closeGradeModal();
        }

        function openEditStudentModal(id) {
            const s = students.find(x => x.id === id);
            document.getElementById('edit-student-id').value = s.id;
            document.getElementById('edit-student-name').value = s.name;
            document.getElementById('edit-student-grade').value = s.grade;
            document.getElementById('edit-student-modal').classList.remove('hidden');
        }
        function closeEditStudentModal() { document.getElementById('edit-student-modal').classList.add('hidden'); }
        function saveStudentDetails() {
            const id = parseInt(document.getElementById('edit-student-id').value);
            const s = students.find(x => x.id === id);
            if(s) {
                s.name = document.getElementById('edit-student-name').value;
                s.grade = document.getElementById('edit-student-grade').value;
                saveData(); init(); closeEditStudentModal();
            }
        }

        function askToClearData() {
            showDialog({
                title: 'تصفير شامل', message: 'سيتم حذف كل شيء!', type: 'danger', isConfirm: true,
                onConfirm: () => { students = []; saveData(); init(); }
            });
        }

        function showDialog(opt) {
            const m = document.getElementById('custom-dialog-modal');
            document.getElementById('custom-dialog-title').innerText = opt.title;
            document.getElementById('custom-dialog-message').innerText = opt.message;
            const icon = document.getElementById('custom-dialog-icon');
            const acts = document.getElementById('custom-dialog-actions');
            
            icon.className = `text-4xl mb-4 block fas ${opt.type==='danger'?'fa-exclamation-triangle text-red-500':opt.type==='success'?'fa-check-circle text-green-500':'fa-info-circle text-blue-500'}`;
            
            acts.innerHTML = '';
            if(opt.isConfirm) {
                acts.innerHTML = `<button onclick="document.getElementById('custom-dialog-modal').classList.add('hidden')" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>`;
                const btn = document.createElement('button');
                btn.className = 'bg-red-600 text-white px-4 py-2 rounded';
                btn.innerText = 'نعم';
                btn.onclick = () => { opt.onConfirm(); document.getElementById('custom-dialog-modal').classList.add('hidden'); };
                acts.appendChild(btn);
            } else {
                acts.innerHTML = `<button onclick="document.getElementById('custom-dialog-modal').classList.add('hidden')" class="bg-gray-800 text-white px-6 py-2 rounded">موافق</button>`;
            }
            m.classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>